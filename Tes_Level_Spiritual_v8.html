<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tes Level Spiritual — Pengasuh Santri (v9)</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f8fc;--card:#fff;--muted:#6d7787;--accent:#244b7e;--line:#e5edf6}
*{box-sizing:border-box}
body{margin:0;font-family:Nunito,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#0b1220}
.container{max-width:980px;margin:28px auto;padding:16px}
.header{background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(10,20,40,.06);text-align:center;margin-bottom:16px}
h1{margin:0;color:var(--accent);font-weight:800}
.sub{color:var(--muted);margin-top:6px}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(30,50,90,.06);margin-bottom:16px}
label{display:block;margin-top:12px;font-weight:700;color:var(--accent)}
input[type=text],textarea,input[type=number],input[type=password]{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fbfdff;margin-top:6px}
button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.btn-ghost{background:transparent;color:var(--accent);border:1px solid #ccdaef}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}

.statement{padding:16px;border:1px solid #edf3fb;border-radius:10px;background:#fff;font-size:18px;line-height:1.5}
.note{font-size:12px;color:#8090a6;margin-top:10px}

.scale-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.scale-item{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;background:#f6f9ff;transition:.15s}
.scale-item:hover{transform:translateY(-1px)}
.scale-item.active{background:#244b7e;color:#fff;border-color:#244b7e}
.scale-key{font-weight:800;min-width:26px;text-align:center}

.cert-wrap{background:#fff;border-radius:14px;padding:22px;box-shadow:0 10px 28px rgba(30,50,90,.08);}
.cert{max-width:820px;margin:8px auto;padding:26px;border-radius:10px;position:relative;background:#fcfdff}
.cert:before,.cert:after{content:"";position:absolute;inset:8px;border:2px solid #d9e2f1;border-radius:8px;pointer-events:none}
.cert h2{color:var(--accent);text-align:center;margin:8px 0}
.meta{text-align:center;color:var(--muted);white-space:pre-wrap}
.badge{display:inline-block;background:#eef6ff;color:var(--accent);padding:6px 12px;border-radius:999px;font-weight:800;border:1px solid #dce9ff}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
.footer{font-size:13px;color:var(--muted);text-align:center;margin-top:18px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Tes Level Spiritual — Pengasuh Santri</h1>
    <div class="sub">Alat Tes ini dikembangkan oleh Multazam Zakaria berdasarkan Peta Kesadaran Dr. David R. Hawkins</div>
  </div>

  <!-- Beranda -->
  <div class="card" id="home">
    <label>Nama Lengkap</label>
    <input id="nama" type="text" placeholder="Nama pengasuh..." />
    <label>Nama Instansi / Pesantren</label>
    <input id="instansi" type="text" placeholder="Nama pesantren / instansi..." />
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button onclick="startTest()">Mulai Tes Spiritual</button>
      <button class="btn-ghost" onclick="openReport()">Laporan Riyadhah Mingguan</button>
      <button class="btn-ghost" onclick="openMember()">Masuk sebagai Member</button>
      <div style="flex:1"></div>
      <button class="btn-ghost" onclick="openAdmin()">Login Admin</button>
    </div>
    <div id="homeNote" class="small" style="margin-top:8px">Silakan isi Nama & Instansi terlebih dahulu.</div>
  </div>

  <!-- Tes -->
  <div class="card hidden" id="testCard">
    <div class="small" id="qCounter"></div>
    <div id="question" class="statement"></div>
    <div class="note">
      Berikan penilaian yang <em>jujur</em> untuk hasil yang sebenarnya (periode 1 bulan terakhir).<br/>
      Ukuran: 1 = Tidak Pernah, 2 = Jarang, 3 = Kadang, 4 = Sering, 5 = Selalu.
    </div>
    <div id="scale" class="scale-list"></div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="prevBtn" class="btn-ghost" onclick="prevQ()">Kembali</button>
      <div style="flex:1"></div>
      <button id="nextBtn" onclick="nextQ()">Lanjut</button>
      <button id="finishBtn" onclick="finishTest()">Selesai & Lihat Sertifikat</button>
      <button class="btn-ghost" onclick="cancelHome()">Batal</button>
    </div>
    <div id="progress" class="small" style="margin-top:10px"></div>
  </div>

  <!-- Hasil -->
  <div class="card hidden" id="resultCard">
    <div class="cert-wrap">
      <div class="cert">
        <div style="text-align:center;margin-bottom:8px"><span class="badge">Sertifikat Hasil Tes</span></div>
        <h2 id="certTitle">Level Spiritual Anda Saat Ini</h2>
        <div class="meta" id="certDesc"></div>
        <div style="margin-top:18px;font-size:15px">
          <div><strong>Nama:</strong> <span id="certNama"></span></div>
          <div><strong>Instansi:</strong> <span id="certInstansi"></span></div>
          <div><strong>Tanggal:</strong> <span id="certTanggal"></span></div>
        </div>
      </div>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="window.print()">Cetak Sertifikat</button>
      <button class="btn-ghost" onclick="saveMember()">Simpan ke Member</button>
      <button class="btn-ghost" onclick="goHome()">Kembali ke Beranda</button>
    </div>
  </div>

  <!-- Laporan Riyadhah -->
  <div class="card hidden" id="reportCard">
    <h3>Laporan Riyadhah Mingguan</h3>
    <div class="small">Isi pekan & jawab satu per satu.</div>
    <label>Pekan ke-</label>
    <input id="weekNo" type="number" min="1" value="1" />
    <div id="reportStep" style="margin-top:12px"></div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="repPrev" class="btn-ghost" onclick="repPrev()">Kembali</button>
      <div style="flex:1"></div>
      <button id="repNext" onclick="repNext()">Lanjut</button>
      <button id="repSend" onclick="sendReport()">Kirim ke Google Sheet</button>
      <button class="btn-ghost" onclick="goHome()">Batal</button>
    </div>
    <div id="reportStatus" class="small" style="margin-top:8px"></div>
  </div>

  <!-- Member -->
  <div class="card hidden" id="memberCard">
    <h3>Member — Riwayat & Laporan</h3>
    <div class="small">Masuk untuk melihat hasil tersimpan atau mengisi laporan.</div>
    <label>Nama</label><input id="memNama" type="text" />
    <label>Instansi</label><input id="memInst" type="text" />
    <div style="margin-top:10px;display:flex;gap:8px">
      <button onclick="memberLogin()">Masuk</button>
      <button class="btn-ghost" onclick="goHome()">Batal</button>
    </div>
    <div id="memberArea" class="hidden" style="margin-top:14px">
      <div>Masuk sebagai: <strong id="memberWho"></strong></div>
      <div style="margin-top:10px">
        <button class="btn-ghost" onclick="memberShow()">Lihat Hasil Terakhir</button>
        <button class="btn-ghost" onclick="memberReport()">Isi Laporan Riyadhah</button>
        <button class="btn-ghost" onclick="memberLogout()">Keluar</button>
      </div>
      <div id="memberInfo" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Admin -->
  <div class="card hidden" id="adminLogin">
    <h3>Admin Panel</h3>
    <div class="small">Masukkan PIN Admin untuk melihat data peserta (perangkat ini).</div>
    <label>PIN Admin</label><input id="adminPin" type="password" placeholder="PIN Admin" />
    <div style="margin-top:10px">
      <button onclick="adminAuth()">Masuk</button>
      <button class="btn-ghost" onclick="goHome()">Batal</button>
    </div>
  </div>

  <div class="card hidden" id="adminPanel">
    <h3>Admin — Daftar Peserta (Perangkat Ini)</h3>
    <table class="table" id="adminTable">
      <thead><tr><th>Nama</th><th>Instansi</th><th>Level</th><th>Waktu</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small" style="margin-top:6px">
      Catatan: Untuk melihat semua hasil dari berbagai perangkat, buka Google Sheet milik Kiai (Apps Script).
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button onclick="exportCSV()">Ekspor CSV</button>
      <button class="btn-ghost" onclick="adminLogout()">Keluar</button>
    </div>
    <div id="adminDetail" style="margin-top:12px"></div>
  </div>

  <div class="footer">© Tes Level Spiritual — Pengasuh Santri</div>
</div>

<script>
// ========= KONFIGURASI =========
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzXx_bR4xSRLfFe86jza6hVw7HUmf9bR_G-4JmpxZHPZGNjkBUYUS_9R9cvTINNWR1Paw/exec';
const ADMIN_PIN = 'AllahSaja';

// ========= DATA LEVEL =========
const LEVELS = [
  // order mengikuti 1..17
  { id:'malu', order:1,  scale:20,  name:'Malu (Shame)',
    description:'Level Malu (Shame) adalah palung terdalam dalam Peta Kesadaran manusia... Kehadiran Anda terasa menjadi racun bagi lingkungan asrama.',
    statements:[
      'Saya sering merasa tidak pantas memimpin atau menjadi teladan bagi santri.',
      'Saya menghindari rapat, interaksi, atau kesempatan tampil karena takut dinilai buruk.',
      'Saya kadang merasa keberadaan saya justru membawa beban bagi lingkungan asrama.',
      'Saya menutup diri dan memilih diam agar tidak mempermalukan diri sendiri.'
    ]},
  { id:'rasa', order:2,  scale:30,  name:'Rasa Bersalah (Guilt)',
    description:'Level Rasa Bersalah (Guilt) merupakan langkah maju dari Malu... sering digunakan ego untuk memblokir kemajuan.',
    statements:[
      'Saya sering menegur santri dengan keras seolah ingin membuktikan bahwa saya bukan penyebab kesalahan mereka.',
      'Saya memaksakan diri bekerja tanpa henti karena merasa belum pantas beristirahat sebelum semua santri berubah.',
      'Saya sering mengulang-ulang penyesalan masa lalu di pikiran saya dan sulit memaafkan diri sendiri.',
      'Saya kadang merasa tenang saat orang bersimpati pada penderitaan saya, seolah itu menebus kesalahan.'
    ]},
  { id:'apatis', order:3,  scale:50,  name:'Apatis (Apathy)',
    description:'Level Apatis (Apathy) adalah kondisi putus asa yang mendalam... Anda telah menyerah memperjuangkan diri sendiri atau santri Anda.',
    statements:[
      'Saya sering menjalankan tugas sekadar agar terlihat bekerja, tanpa sungguh-sungguh percaya akan hasilnya.',
      'Saya merasa para santri memang sulit berubah, seolah-olah usaha apa pun akan sia-sia.',
      'Saya jarang memikirkan masa depan pengasuhan; fokus saya hanya bagaimana bertahan hari ini.',
      'Saya sering membiarkan santri atau rekan bergantung pada saya dalam hal kecil karena itu membuat saya merasa masih dibutuhkan, walau sebenarnya saya sudah lelah.'
    ]},
  { id:'sedih', order:4,  scale:75,  name:'Sedih (Grief)',
    description:'Level Sedih (Grief) adalah kondisi duka dan penyesalan yang aktif... energi ini terikat kuat pada masa lalu.',
    statements:[
      'Saya sering membandingkan santri sekarang dengan angkatan dulu dan merasa zaman terbaik sudah lewat.',
      'Saya sering kecewa dan mengeluh karena kondisi santri sekarang tidak seperti yang saya harapkan.',
      'Saya merasa sangat kehilangan ketika ada santri yang keluar, seolah semua kerja keras saya menjadi sia-sia.',
      'Saya sering menyesali keputusan masa lalu dalam mengasuh, hingga ragu untuk mengambil keputusan baru sekarang.'
    ]},
  { id:'takut', order:5,  scale:100, name:'Takut (Fear)',
    description:'Level Takut (Fear) adalah kondisi kecemasan yang konstan... keputusan didasarkan pada upaya menghindari bahaya.',
    statements:[
      'Saya membuat banyak aturan kecil karena merasa semuanya akan berantakan jika saya tidak mengontrol setiap detail.',
      'Saya sering menunda menegur santri bermasalah karena takut reaksi mereka akan memperburuk keadaan.',
      'Saya sering membayangkan hal buruk yang mungkin terjadi dan sulit menikmati ketenangan hari ini.',
      'Saya menjaga jarak dengan santri atau rekan kerja karena takut terluka atau dikecewakan.'
    ]},
  { id:'keinginan', order:6,  scale:125, name:'Keinginan (Desire)',
    description:'Level Keinginan (Desire) adalah kondisi ambisi dan kerinduan yang intens... sering berujung kekecewaan.',
    statements:[
      'Saya merasa puas jika santri atau program saya berhasil karena itu membuat saya terlihat berprestasi di mata orang lain.',
      'Saya sering melihat keberhasilan santri sebagai cerminan kemampuan saya, dan kegagalan mereka membuat saya malu.',
      'Saya mudah kecewa ketika target tidak tercapai atau ketika pujian yang saya harapkan tidak datang.',
      'Saya sering membandingkan diri dengan pengasuh atau pesantren lain dan merasa harus menjadi yang paling unggul.'
    ]},
  { id:'marah', order:7,  scale:150, name:'Marah (Anger)',
    description:'Level Marah (Anger) adalah kondisi kebencian dan permusuhan yang aktif... energinya tinggi namun destruktif.',
    statements:[
      'Saya kadang memberikan hukuman lebih berat dari seharusnya karena merasa kesal dan ingin memberi pelajaran keras.',
      'Saya menyadari bahwa suasana asrama sering menjadi tegang karena santri takut akan reaksi saya.',
      'Saya sulit melupakan santri atau rekan yang pernah membuat saya marah, dan itu memengaruhi sikap saya terhadap mereka.',
      'Saya sering menyalahkan situasi atau orang lain ketika terjadi masalah, daripada mencari peran saya di dalamnya.'
    ]},
  { id:'bangga', order:8,  scale:175, name:'Bangga (Pride)',
    description:'Level Bangga (Pride) adalah kondisi kesombongan dan ilusi keunggulan... rapuh dan defensif.',
    statements:[
      'Saya sering merasa saran dari rekan atau pimpinan tidak relevan, karena saya yakin hanya saya yang benar-benar paham kondisi santri saya.',
      'Saya merasa penting menjaga citra pengasuh berwibawa, meski saya tahu ada hal batin santri yang belum saya sentuh.',
      'Saya kadang merasa lebih baik dari pengasuh lain yang gagal, atau dari santri yang tidak berkembang cepat.',
      'Saya sering menyalahkan sistem atau lingkungan saat terjadi masalah, daripada mengakui bagian saya di dalamnya.'
    ]},
  { id:'keberanian', order:9,  scale:200, name:'Keberanian (Courage)',
    description:'Titik Kritis (Tipping Point). Anda tidak lagi lumpuh oleh ketakutan atau ego... aktif mencari pelatihan & mencoba metode baru.',
    statements:[
      'Saya berani mengakui kesalahan tanpa merasa rendah diri, karena kesalahan adalah bagian dari proses belajar.',
      'Saya mau mencoba cara baru dalam mendidik santri meski belum tentu berhasil.',
      'Saya melihat kesulitan sebagai tantangan yang bisa dipelajari, bukan beban yang harus dihindari.',
      'Saya aktif mencari ilmu/pelatihan untuk meningkatkan kualitas diri dan pengasuhan.'
    ]},
  { id:'netralitas', order:10, scale:250, name:'Netralitas (Neutrality)',
    description:'Kondisi kenyamanan, kelenturan, dan non-penghakiman... keamanan batin tidak bergantung kondisi luar.',
    statements:[
      'Saya mampu menyesuaikan diri dengan perubahan aturan atau kebijakan baru tanpa panik.',
      'Saya menjalankan tugas pengasuhan dengan tenang tanpa membawa stres ke luar asrama.',
      'Saya berusaha memahami santri dan rekan kerja tanpa memberi label “baik/buruk”.',
      'Saya merasa nyaman dengan keputusan saya, meski tidak semua orang setuju.'
    ]},
  { id:'kemauan', order:11, scale:310, name:'Kemauan (Willingness)',
    description:'Kondisi proaktif, antusias, dan niat baik... komitmen penuh pada perbaikan & pembelajaran.',
    statements:[
      'Saya bersemangat dalam menjalankan peran dan semangat itu menular.',
      'Saya dengan sukacita mencari ilmu baru untuk menjadi pengasuh lebih bijak.',
      'Saya melihat masalah sebagai kesempatan untuk belajar dan memperbaiki cara mendidik.',
      'Saya memiliki komitmen jangka panjang terhadap pembentukan karakter santri.'
    ]},
  { id:'penerimaan', order:12, scale:350, name:'Penerimaan (Acceptance)',
    description:'Wawasan damai bahwa segala sesuatu berjalan sebagaimana mestinya... bebas dari keterikatan hasil.',
    statements:[
      'Saya mampu memaafkan santri dan diri saya sendiri dengan tulus, tanpa menyimpan luka.',
      'Saya berfokus pada apa yang bisa saya lakukan hari ini.',
      'Saya menerima setiap santri apa adanya, tanpa memaksa mereka menjadi versi ideal saya.',
      'Saya tetap tenang saat terjadi konflik, karena setiap gesekan adalah bagian dari pertumbuhan.'
    ]},
  { id:'akal', order:13, scale:400, name:'Akal Budi (Reason)',
    description:'Kondisi intelektual, logis, dan rasional... memimpin dengan data, logika, strategi.',
    statements:[
      'Saya menata sistem pengasuhan secara terstruktur dan logis agar adil dan konsisten.',
      'Saya membuat keputusan berdasarkan data dan fakta, bukan sekadar perasaan.',
      'Saya terus memperdalam ilmu untuk meningkatkan kompetensi.',
      'Saya berkomunikasi jernih dan objektif agar santri memahami, bukan sekadar patuh.'
    ]},
  { id:'cinta', order:14, scale:500, name:'Cinta (Love)',
    description:'Kasih sayang tanpa syarat dan rasa hormat mendalam terhadap kehidupan... memimpin dengan welas asih.',
    statements:[
      'Saya melayani santri dengan cinta dan keinginan tulus untuk melihat mereka tumbuh.',
      'Saya melihat potensi dan kebaikan ilahi di balik setiap perilaku santri.',
      'Saya mengampuni dengan mudah tanpa menunggu permintaan maaf.',
      'Saya menciptakan suasana aman dan tenang sehingga santri berani membuka diri.'
    ]},
  { id:'suka', order:15, scale:540, name:'Suka Cita (Joy)',
    description:'Kebahagiaan batin stabil dan independen... energi riang yang transformatif.',
    statements:[
      'Saya merasakan kegembiraan alami dalam peran saya dan itu menular pada sekitar.',
      'Saya menemukan keindahan dalam rutinitas sederhana setiap hari sebagai karunia Allah.',
      'Saya tetap bahagia apa pun hasil pengasuhan, karena kebahagiaan saya tidak bergantung hasil.',
      'Saya merasakan ide dan solusi kreatif mengalir karena hati bebas dari ketakutan/ego.'
    ]},
  { id:'kedamaian', order:16, scale:600, name:'Kedamaian (Peace)',
    description:'Transendensi & keheningan mendalam... kehadiran menenangkan seluruh komunitas.',
    statements:[
      'Saya tidak melawan masalah; saya mengizinkannya ada dan menemukan kedamaian di tengahnya.',
      'Saya sadar ketenangan saya lebih kuat dari ribuan kata; kehadiran saya mendamaikan.',
      'Saya hidup seimbang antara aktivitas dan keheningan, berpikir dan merasa.',
      'Saya merasa bertindak sebagai saluran kehendak Allah, bukan dari ego pribadi.'
    ]},
  { id:'pencerahan', order:17, scale:850, name:'Pencerahan (Enlightenment)',
    description:'Kesadaran murni, Kesatuan, dan Realitas Tertinggi… menjadi instrumen perubahan spiritual.',
    statements:[
      'Saya tidak lagi merasa sebagai pelaku; semua yang terjadi hanyalah kehendak Allah yang bekerja melalui saya.',
      'Saya melihat setiap santri dan peristiwa sebagai satu kesatuan dengan diri saya.',
      'Saya hadir bukan untuk mengubah, namun kehadiran saya membawa perubahan tanpa kata.',
      'Saya hidup dalam keheningan batin di mana kasih dan kehendak Allah mengalir tanpa hambatan.'
    ]}
];

// ========= STATE & UTIL =========
let app = {
  nama:'', instansi:'',
  currentQ:0,
  answers:Array(LEVELS.length*4).fill(null),
  result:null,
  report:{current:0, answers:['','','']},
  member:null
};
const SCALE = [
  {key:1,label:'Tidak Pernah'},
  {key:2,label:'Jarang'},
  {key:3,label:'Kadang'},
  {key:4,label:'Sering'},
  {key:5,label:'Selalu'},
];

function qs(id){return document.getElementById(id)}
function show(id){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); qs(id).classList.remove('hidden'); window.scrollTo(0,0);}
function goHome(){show('home')}
function cancelHome(){if(confirm('Batalkan tes dan kembali?')) goHome();}

// ========= TES =========
function startTest(){
  const n=qs('nama').value.trim(), ins=qs('instansi').value.trim();
  if(!n||!ins) return alert('Mohon isi Nama & Instansi terlebih dahulu.');
  app.nama=n; app.instansi=ins; app.currentQ=0; app.answers=Array(LEVELS.length*4).fill(null);
  show('testCard'); renderQuestion();
}
function renderQuestion(){
  const i=app.currentQ, li=Math.floor(i/4), si=i%4;
  qs('qCounter').innerText = `Pertanyaan ${i+1} / ${LEVELS.length*4}`;
  qs('question').innerHTML = `<strong>${i+1}.</strong> ${LEVELS[li].statements[si]}`;
  const box = qs('scale'); box.innerHTML='';
  SCALE.forEach(item=>{
    const div = document.createElement('div');
    div.className='scale-item'+(app.answers[i]===item.key?' active':'');
    div.onclick=()=>{app.answers[i]=item.key; renderQuestion();}
    div.innerHTML = `<div class="scale-key">${item.key}</div><div>${item.label}</div>`;
    box.appendChild(div);
  });
  qs('prevBtn').classList.toggle('hidden', i===0);
  qs('nextBtn').classList.toggle('hidden', i===LEVELS.length*4-1);
  qs('finishBtn').classList.toggle('hidden', i!==LEVELS.length*4-1);
  qs('progress').innerText = `Terisi: ${app.answers.filter(x=>x!==null).length} / ${LEVELS.length*4}`;
}
function nextQ(){ if(app.answers[app.currentQ]==null) return alert('Mohon pilih jawaban.'); app.currentQ++; renderQuestion(); }
function prevQ(){ app.currentQ--; renderQuestion(); }

async function finishTest(){
  if(app.answers.includes(null)) return alert('Mohon jawab semua pertanyaan.');
  // hitung rata-rata per level
  const scores=[]; let idx=0;
  for(let i=0;i<LEVELS.length;i++){ let sum=0; for(let j=0;j<4;j++) sum+=app.answers[idx++]; scores.push({index:i, avg:sum/4}); }
  // dominan: avg tertinggi; jika seri, pilih level dengan order lebih tinggi
  let best=scores[0];
  for(const s of scores){ if(s.avg>best.avg) best=s; else if(s.avg===best.avg && s.index>best.index) best=s; }
  const dom = LEVELS[best.index];

  app.result = {
    nama: app.nama, instansi: app.instansi, time:new Date().toISOString(),
    dominantIndex: best.index, dominant: {name:dom.name, order:dom.order, scale:dom.scale, description:dom.description},
    answers: app.answers
  };

  // tampil sertifikat
  qs('certTitle').innerText = `Saat ini Anda berada di Level ${dom.name} (${dom.order}/17)`;
  qs('certDesc').innerText = dom.description || '';
  qs('certNama').innerText = app.nama;
  qs('certInstansi').innerText = app.instansi;
  qs('certTanggal').innerText = new Date(app.result.time).toLocaleString('id-ID');

  show('resultCard');

  // simpan ke local index (untuk Admin perangkat ini)
  saveToLocalIndex(app.result);

  // kirim ke Google Sheet (Apps Script)
  try{
    await fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        type:'result',
        nama: app.result.nama,
        instansi: app.result.instansi,
        level: dom.name,
        order: dom.order,
        skor: best.avg.toFixed(2),
        jawaban: app.result.answers,
        waktu_client: new Date().toLocaleString('id-ID')
      })
    });
  }catch(e){
    console.warn('Gagal kirim ke Google Sheet:', e);
  }
}

// ========= LAPORAN RIYADHAH =========
const reportQ = [
  'Aksi Riyadhah apa saja yang sudah Anda jalankan pekan ini?',
  'Perubahan seperti apa yang Anda rasakan di dalam diri Anda?',
  'Perubahan seperti apa yang Anda rasakan di sekitar/luar diri Anda?'
];
function openReport(){
  const n=qs('nama').value.trim(), ins=qs('instansi').value.trim();
  if(!n||!ins) return alert('Isi Nama & Instansi di beranda.');
  app.nama=n; app.instansi=ins; app.report={current:0, answers:['','','']};
  renderReportStep(); show('reportCard');
}
function renderReportStep(){
  const i=app.report.current;
  qs('reportStep').innerHTML = `<label>${reportQ[i]}</label><textarea id="repAns" rows="6">${app.report.answers[i]||''}</textarea>`;
  qs('repPrev').classList.toggle('hidden', i===0);
  qs('repNext').classList.toggle('hidden', i===reportQ.length-1);
  qs('repSend').classList.toggle('hidden', i!==reportQ.length-1);
}
function repNext(){
  const v=qs('repAns').value.trim(); if(!v) return alert('Mohon isi jawaban lebih dulu.');
  app.report.answers[app.report.current]=v; app.report.current++; renderReportStep();
}
function repPrev(){ app.report.current--; renderReportStep(); }
async function sendReport(){
  const v=qs('repAns').value.trim(); if(!v) return alert('Mohon isi jawaban.');
  app.report.answers[app.report.current]=v;
  const payload = {
    type:'report',
    nama: app.nama,
    instansi: app.instansi,
    pekan: qs('weekNo').value || '1',
    waktu_client: new Date().toLocaleString('id-ID'),
    dominant: app.result ? app.result.dominant.name : '',
    laporan: {
      aksi: app.report.answers[0],
      perubahan_diri: app.report.answers[1],
      perubahan_luar: app.report.answers[2]
    }
  };
  qs('reportStatus').innerText = 'Mengirim laporan ke Google Sheet...';
  try{
    const res = await fetch(GAS_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(res.ok) qs('reportStatus').innerText='Terima kasih — laporan berhasil dikirim.';
    else qs('reportStatus').innerText='Gagal mengirim; coba lagi.';
  }catch(e){
    qs('reportStatus').innerText='Kesalahan jaringan; coba lagi.';
  }
}

// ========= MEMBER =========
function openMember(){ show('memberCard'); qs('memNama').value = qs('nama').value; qs('memInst').value = qs('instansi').value; }
function memberLogin(){
  const n=qs('memNama').value.trim(), ins=qs('memInst').value.trim();
  if(!n||!ins) return alert('Nama & Instansi wajib.');
  app.member = {nama:n, instansi:ins}; qs('memberArea').classList.remove('hidden');
  qs('memberWho').innerText = `${n} — ${ins}`;
  const key = keyFor(n,ins);
  const data = localStorage.getItem(key);
  qs('memberInfo').innerHTML = data ? `Hasil terakhir: <strong>${JSON.parse(data).dominant.name}</strong> (${new Date(JSON.parse(data).time).toLocaleString('id-ID')})` : 'Belum ada hasil.';
}
function memberShow(){
  const n=app.member?.nama, ins=app.member?.instansi; if(!n||!ins) return alert('Belum login member.');
  const key = keyFor(n,ins); const data = localStorage.getItem(key);
  if(!data) return alert('Tidak ada hasil tersimpan.');
  const r = JSON.parse(data); app.result = r;
  const dom = LEVELS[r.dominantIndex] || r.dominant;
  const orderTxt = dom.order ? ` (${dom.order}/17)` : '';
  qs('certTitle').innerText = `Saat ini Anda berada di Level ${dom.name}${orderTxt}`;
  qs('certDesc').innerText = dom.description || '';
  qs('certNama').innerText = r.nama; qs('certInstansi').innerText = r.instansi; qs('certTanggal').innerText = new Date(r.time).toLocaleString('id-ID');
  show('resultCard');
}
function memberReport(){ show('reportCard'); app.report = {current:0, answers:['','','']}; renderReportStep(); }
function memberLogout(){ app.member=null; show('home'); }

// ========= ADMIN (perangkat ini) =========
function openAdmin(){ show('adminLogin'); }
function adminAuth(){ const p=qs('adminPin').value.trim(); if(p===ADMIN_PIN){ loadAdmin(); show('adminPanel'); } else alert('PIN salah.'); }
function adminLogout(){ qs('adminPin').value=''; show('home'); }
function loadAdmin(){
  const tbody = qs('adminTable').querySelector('tbody'); tbody.innerHTML='';
  const idx = JSON.parse(localStorage.getItem('tsp_index')||'[]');
  idx.sort((a,b)=> new Date(b.time)-new Date(a.time));
  idx.forEach(item=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${item.nama}</td><td>${item.instansi}</td><td>${item.level||''}</td><td>${new Date(item.time).toLocaleString('id-ID')}</td>
    <td><button class='btn-ghost' onclick="adminView('${item.key}')">Lihat</button> <button class='btn-ghost' onclick="adminDel('${item.key}')">Hapus</button></td>`;
    tbody.appendChild(tr);
  });
}
function adminView(key){
  const data = JSON.parse(localStorage.getItem(key)||'null'); if(!data) return alert('Data tidak ditemukan.');
  let html = `<div><strong>${data.nama}</strong> — ${data.instansi}</div><div class='small'>${new Date(data.time).toLocaleString('id-ID')}</div>`;
  html += `<div style='margin-top:8px'><strong>Level:</strong> ${data.dominant?.name||''} (${(LEVELS[data.dominantIndex]||{}).order||''}/17)</div>`;
  html += `<pre style='white-space:pre-wrap;background:#fbfbfd;border:1px solid #eef2ff;padding:10px;border-radius:8px;margin-top:8px'>${JSON.stringify(data,null,2)}</pre>`;
  qs('adminDetail').innerHTML = html;
}
function adminDel(key){
  if(!confirm('Hapus data ini dari perangkat?')) return;
  localStorage.removeItem(key);
  let idx = JSON.parse(localStorage.getItem('tsp_index')||'[]');
  idx = idx.filter(i=>i.key!==key);
  localStorage.setItem('tsp_index', JSON.stringify(idx));
  loadAdmin();
}
function exportCSV(){
  const idx = JSON.parse(localStorage.getItem('tsp_index')||'[]');
  if(!idx.length) return alert('Tidak ada data untuk diekspor.');
  const rows = [['Nama','Instansi','Level','Waktu','Jawaban']];
  idx.forEach(item=>{
    const data = JSON.parse(localStorage.getItem(item.key)||'null')||{};
    rows.push([ data.nama||item.nama, data.instansi||item.instansi, (data.dominant&&data.dominant.name)||item.level, new Date((data.time||item.time)).toLocaleString('id-ID'), JSON.stringify(data.answers||[]) ]);
  });
  const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tsp_export.csv'; a.click(); URL.revokeObjectURL(url);
}

// ========= LOCAL STORAGE HELPERS =========
function keyFor(nama,instansi){ return `tsp_${nama.replace(/\s+/g,'_')}_${instansi.replace(/\s+/g,'_')}`; }
function saveToLocalIndex(result){
  const key = keyFor(result.nama, result.instansi);
  localStorage.setItem(key, JSON.stringify(result));
  let idx = JSON.parse(localStorage.getItem('tsp_index')||'[]');
  if(!idx.find(i=>i.key===key)) idx.push({key, nama:result.nama, instansi:result.instansi, time:result.time, level:result.dominant.name});
  else idx = idx.map(i=> i.key===key ? {...i, time:result.time, level:result.dominant.name} : i);
  localStorage.setItem('tsp_index', JSON.stringify(idx));
}

// ========= INIT =========
goHome();
</script>
</body>
</html>
